From 6e1b852c4bc971f9cf40ffb963ab7965eafe4dea Mon Sep 17 00:00:00 2001
From: William Douglas <william.douglas@intel.com>
Date: Wed, 26 Jun 2024 15:33:52 -0700
Subject: [PATCH] Makefile fixups

Signed-off-by: William Douglas <william.douglas@intel.com>
---
 makefile | 25 +++++++++++++++----------
 1 file changed, 15 insertions(+), 10 deletions(-)

diff --git a/makefile b/makefile
index 41a2928..3fbf38f 100644
--- a/makefile
+++ b/makefile
@@ -1,6 +1,14 @@
 LIBNAME = lpeg
-LUADIR = ./lua/
+LUAPC ?= lua
+LUADIR ?= $(shell pkg-config --variable=includedir $(LUAPC))
+VERSION ?= 1.0.2
+LUAVERSION ?= 5.4
+LUAVERSION51 ?= 5.1
 
+DESTDIR ?= ""
+PREFIX ?= $(DESTDIR)/usr
+LIBDIR = $(PREFIX)/lib
+DATADIR = $(PREFIX)/share
 COPT = -O2 -DNDEBUG
 # COPT = -O0 -DLPEG_DEBUG -g
 
@@ -30,16 +38,8 @@ CC = gcc
 
 FILES = lpvm.o lpcap.o lptree.o lpcode.o lpprint.o lpcset.o
 
-# For Linux
-linux:
-	$(MAKE) lpeg.so "DLLFLAGS = -shared -fPIC"
-
-# For Mac OS
-macosx:
-	$(MAKE) lpeg.so "DLLFLAGS = -bundle -undefined dynamic_lookup"
-
 lpeg.so: $(FILES)
-	env $(CC) $(DLLFLAGS) $(FILES) -o lpeg.so
+	env $(CC) -shared -fPIC $(LDFLAGS) $(FILES) -o lpeg.so
 
 $(FILES): makefile
 
@@ -49,6 +49,11 @@ test: test.lua re.lua lpeg.so
 clean:
 	rm -f $(FILES) lpeg.so
 
+.PHONY: install
+install:
+	install -p -Dm 0755 lpeg.so $(LIBDIR)/lua/$(LUAVERSION)/lpeg.so
+	install -p -Dm 0755 lpeg.so $(LIBDIR)/lua/$(LUAVERSION51)/lpeg.so
+	install -p -Dm 0644 re.lua $(DATADIR)/lua/$(LUAVERSION)/re.lua
 
 lpcap.o: lpcap.c lpcap.h lptypes.h
 lpcode.o: lpcode.c lptypes.h lpcode.h lptree.h lpvm.h lpcap.h lpcset.h
-- 
2.45.2

